<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Курсы</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        --bg: #ffffff;
        --fg: #111;
        --muted: #666;
        --card: #fff;
        --shadow: rgba(0, 0, 0, 0.08);
        --divider: rgba(0, 0, 0, 0.06);
      }
      body[data-theme="dark"] {
        --bg: #0f0f10;
        --fg: #f1f1f1;
        --muted: #a0a0a0;
        --card: #161719;
        --shadow: rgba(0, 0, 0, 0.5);
        --divider: rgba(255, 255, 255, 0.08);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
      }
      .wrap {
        padding: 16px;
        max-width: 680px;
        margin: 0 auto;
      }
      .card {
        padding: 16px;
        border-radius: 14px;
        background: var(--card);
        box-shadow: 0 6px 20px var(--shadow);
        margin-bottom: 14px;
      }
      h1 {
        margin: 0 0 12px;
        font-size: 18px;
      }
      h2 {
        margin: 0 0 10px;
        font-size: 16px;
        opacity: 0.9;
      }
      .subtitle {
        margin: 0 0 12px;
        color: var(--muted);
        font-size: 13px;
      }
      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid var(--divider);
      }
      .row:last-child {
        border-bottom: none;
      }
      .pair {
        font-weight: 600;
      }
      .val {
        font-variant-numeric: tabular-nums;
      }
      .foot {
        margin-top: 10px;
        color: var(--muted);
        font-size: 12px;
      }
      .err {
        color: #e74c3c;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Курсы</h1>
        <p class="subtitle">
          Нажмите «Обновить», чтобы подтянуть свежие значения.
        </p>

        <h2>Фиат → RUB</h2>
        <div id="fiat-list"></div>

        <h2 style="margin-top: 12px">Крипто → USD</h2>
        <div id="crypto-list"></div>

        <div class="foot" id="updated"></div>
        <div class="foot err" id="error"></div>
      </div>
    </div>

    <script>
      const tg = window.Telegram?.WebApp;
      tg?.ready();
      tg?.expand();
      document.body.setAttribute(
        "data-theme",
        tg?.colorScheme === "dark" ? "dark" : "light"
      );

      // ---------- Конфиг пар ----------
      const FIAT_PAIRS = [
        { base: "USD", quote: "RUB" },
        { base: "EUR", quote: "RUB" },
        { base: "CNY", quote: "RUB" }, // юань
      ];
      // CoinGecko ids -> tickers
      const CRYPTO = [
        { id: "bitcoin", sym: "BTC", vs: "USD" },
        { id: "ethereum", sym: "ETH", vs: "USD" },
        { id: "solana", sym: "SOL", vs: "USD" },
        { id: "cosmos", sym: "ATOM", vs: "USD" }, // Cosmos Hub
      ];

      // ---------- Утилиты ----------
      const fmt = (n) => Number(n).toFixed(4);
      function row(pair, value) {
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `<span class="pair">${pair}</span><span class="val">${
          value ?? "—"
        }</span>`;
        return div;
      }

      // ---------- Загрузка фиатных пар через exchangerate.host ----------
      async function loadFiat() {
        // по одной загрузке на каждую base (USD/EUR/CNY) с нужным quote
        const results = await Promise.all(
          FIAT_PAIRS.map(async ({ base, quote }) => {
            const url = `https://api.exchangerate.host/latest?base=${encodeURIComponent(
              base
            )}&symbols=${encodeURIComponent(quote)}`;
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) throw new Error("Fiat HTTP " + res.status);
            const data = await res.json();
            const rate = data?.rates?.[quote];
            return { pair: `${base}/${quote}`, rate, date: data?.date };
          })
        );
        return results;
      }

      // ---------- Загрузка крипты через CoinGecko ----------
      async function loadCrypto() {
        const ids = CRYPTO.map((x) => x.id).join(",");
        const vs = "usd";
        const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(
          ids
        )}&vs_currencies=${vs}`;
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("Crypto HTTP " + res.status);
        const data = await res.json();
        const out = CRYPTO.map(({ id, sym, vs }) => {
          const v = data?.[id]?.[vs.toLowerCase()];
          return { pair: `${sym}/${vs}`, rate: v };
        });
        return out;
      }

      async function loadAll() {
        const errorEl = document.getElementById("error");
        const fiatList = document.getElementById("fiat-list");
        const cryptoList = document.getElementById("crypto-list");
        const updated = document.getElementById("updated");
        errorEl.textContent = "";
        fiatList.innerHTML = "";
        cryptoList.innerHTML = "";

        try {
          const [fiat, crypto] = await Promise.all([loadFiat(), loadCrypto()]);

          // Фиат
          fiat.forEach(({ pair, rate }) =>
            fiatList.appendChild(row(pair, rate ? fmt(rate) : "—"))
          );

          // Крипта
          crypto.forEach(({ pair, rate }) =>
            cryptoList.appendChild(row(pair, rate ? fmt(rate) : "—"))
          );

          updated.textContent = "Обновлено: " + new Date().toLocaleString();
        } catch (e) {
          errorEl.textContent = "Не удалось получить курсы. Попробуйте позже.";
        }
      }

      tg?.MainButton.setText("Обновить").show().onClick(loadAll);
      loadAll();
    </script>
  </body>
</html>
